# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Node.js CI

# run on pull requests targeting main and pushes to any branch
on:
  pull_request:
    branches: [ $default-branch ]
    paths:
      - src/backend/**
      - .github/workflows/node.yaml
  push:
    paths:
      - src/backend/**
      - .github/workflows/node.yaml

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  test-node:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Start MySQL
      run: sudo service mysql start

    # - name: Set up custom MySQL
    #   uses: mirromutth/mysql-action@v1.1
    #   with:
    #     character set server: 'utf8mb3'
    #     collation server: 'utf8mb4_unicode_ci'
    #     mysql version: '9.2'
    #     mysql database: 'GetGrinnected'
    #     mysql root password: ${{ secrets.MYSQL_CI_ROOT_PASSWORD }}

    # - name: Initialize mysql database from CI file
    #   # This will warn us not to use a secret on the command line,
    #   # but it's fine because this db doesn't store anything real
    #   run: |
    #     mysql -uroot -p${{ secrets.MYSQL_CI_ROOT_PASSWORD }} GetGrinnected < \
    #     ${GITHUB_WORKSPACE}/src/backend/Database/GetGrinnected_CI_Data.sql

    - name: Test with npm
      uses: actions/setup-node@v4
      with:
        node-version: 22.x
        cache: 'npm'

    - name: Fresh-install packages
      run: npm ci

    - name: Run tests
      run: npm test
      # set the env so it runs correctly, this replaces a .env file
      env:
        # secrets for JWT tokens only they're not very secret because they
        # are only for CI
        REFRESH_TOKEN_SECRET: "test_test_test_test_test_test_te"
        ACCESS_TOKEN_SECRET: "ci_ci_ci_ci_ci_ci_ci_ci_ci_ci_ci"
        # connection to the database
        MYSQL_HOST: localhost
        MYSQL_USER: root
        MYSQL_PASSWORD: root
        MYSQL_DATABASE: GetGrinnected
